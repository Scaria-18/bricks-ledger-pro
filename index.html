<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Interlocking Brick Ledger - Premium</title>
    <!-- Load Tailwind CSS --><script src="https://cdn.tailwindcss.com"></script>
    <!-- Load Inter Font --><style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8fafc; /* Very light, soft background */
            color: #1e293b; /* Darker text for high contrast */
        }
        /* Custom scrollbar for better mobile feel and premium look */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #e2e8f0; /* Lighter track */
        }
        ::-webkit-scrollbar-thumb {
            background: #60a5fa; /* Blue thumb */
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #3b82f6; /* Darker blue on hover */
        }
        /* Custom styles for focus rings to match the premium theme */
        .focus-ring-blue-500:focus {
            outline: none;
            border-color: #3b82f6; /* Blue border */
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.4); /* Blue glow */
        }
        /* Style for the Modal backdrop */
        .modal-backdrop {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6); /* Slightly darker backdrop */
            z-index: 99;
            display: none; /* Controlled by JS */
            transition: opacity 0.3s ease-in-out;
        }
        .modal-content {
            background-color: white;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            max-height: 90vh;
            overflow-y: auto;
            z-index: 100;
        }
        /* Custom shadow for premium lift effect */
        .premium-shadow {
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.05), 0 4px 6px -2px rgba(0, 0, 0, 0.02);
        }
    </style>
</head>
<body class="min-h-screen">

    <div id="app" class="max-w-5xl mx-auto p-4 md:p-8 space-y-8">

        <!-- Header and Auth Info --><header class="bg-gradient-to-r from-blue-800 to-indigo-900 text-white p-6 rounded-xl shadow-2xl flex items-center justify-between">
            <div>
                <h1 class="text-3xl font-extrabold tracking-wider">Brick Ledger Pro</h1>
                <p class="text-sm mt-1 opacity-80">Advanced transaction tracking for your interlocking brick business.</p>
            </div>
            <p id="user-id-display" class="text-xs bg-blue-900/50 px-3 py-1 rounded-full overflow-x-auto whitespace-nowrap hidden md:block">
                Loading User...
            </p>
        </header>

        <!-- Loading Indicator --><div id="loading-spinner" class="text-center p-12">
            <div class="animate-spin rounded-full h-12 w-12 border-b-4 border-blue-600 mx-auto"></div>
            <p class="mt-4 text-gray-600 font-medium">Connecting to ledger...</p>
        </div>

        <!-- Main Content (Hidden until loaded) --><main id="main-content" class="hidden space-y-8">
            
            <!-- Period Management Section (NEW) -->
            <section class="bg-white p-6 rounded-xl premium-shadow border border-gray-100 flex flex-col md:flex-row justify-between items-center space-y-4 md:space-y-0">
                <div class="text-sm font-medium text-gray-700">
                    <p class="text-lg font-bold text-gray-900">Active Ledger: <span id="current-period-display" class="text-blue-600">Loading...</span></p>
                    <p class="mt-1 text-sm">Starting Balance: <span id="starting-balance-display" class="font-extrabold text-green-700">₹0.00</span></p>
                </div>
                
                <div class="flex items-center space-x-4 w-full md:w-auto">
                    <select id="ledger-view-selector" onchange="switchLedgerView(this.value)"
                        class="px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus-ring-blue-500 text-sm bg-gray-50 hover:bg-gray-100 transition duration-150 ease-in-out">
                        <option value="Current Period">View Current Period</option>
                        <option value="All History">View All History</option>
                    </select>

                    <button onclick="openClosePeriodModal()"
                        class="py-2.5 px-4 border border-transparent rounded-lg shadow-md text-sm font-medium text-white bg-red-600 hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500 transition duration-150 ease-in-out transform hover:scale-105 w-full md:w-auto">
                        Close Period & Roll Forward
                    </button>
                </div>
            </section>

            <!-- Summary Cards --><section class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6">
                <!-- Card 1: Revenue -->
                <div class="bg-white p-6 rounded-xl premium-shadow border border-blue-100 hover:bg-blue-50/50 transition-colors duration-300 relative overflow-hidden">
                    <div class="absolute inset-y-0 left-0 w-1 bg-blue-600 rounded-l-lg"></div>
                    <p class="text-sm text-gray-600 font-medium ml-3">Gross Revenue (Period)</p>
                    <p id="total-revenue" class="text-3xl font-extrabold text-blue-800 mt-2 ml-3">₹0.00</p>
                </div>
                <!-- Card 2: Expenses -->
                <div class="bg-white p-6 rounded-xl premium-shadow border border-red-100 hover:bg-red-50/50 transition-colors duration-300 relative overflow-hidden">
                    <div class="absolute inset-y-0 left-0 w-1 bg-red-600 rounded-l-lg"></div>
                    <p class="text-sm text-gray-600 font-medium ml-3">Total Expenses (Period)</p>
                    <p id="total-expenses" class="text-3xl font-extrabold text-red-800 mt-2 ml-3">₹0.00</p>
                </div>
                <!-- Card 3: Pending -->
                <div class="bg-white p-6 rounded-xl premium-shadow border border-yellow-100 hover:bg-yellow-50/50 transition-colors duration-300 relative overflow-hidden">
                    <div class="absolute inset-y-0 left-0 w-1 bg-yellow-600 rounded-l-lg"></div>
                    <p class="text-sm text-gray-600 font-medium ml-3">Pending Revenue (Period)</p>
                    <p id="pending-revenue" class="text-3xl font-extrabold text-yellow-800 mt-2 ml-3">₹0.00</p>
                </div>
                <!-- Card 4: Net Balance -->
                <div class="bg-white p-6 rounded-xl premium-shadow border border-green-100 hover:bg-green-50/50 transition-colors duration-300 relative overflow-hidden">
                    <div class="absolute inset-y-0 left-0 w-1 bg-green-600 rounded-l-lg"></div>
                    <p id="net-balance-label" class="text-sm text-gray-600 font-medium ml-3">Realized Net Balance (Period)</p>
                    <p id="net-balance" class="text-3xl font-extrabold text-green-800 mt-2 ml-3">₹0.00</p>
                </div>
            </section>

            <!-- Transaction Form --><section class="bg-white p-6 md:p-8 rounded-xl shadow-2xl border border-gray-100">
                <h2 class="text-2xl font-semibold mb-6 text-gray-800">Record New Transaction</h2>
                <form id="transaction-form" class="space-y-5">

                    <!-- Type Selector & Brick Type --><div class="grid grid-cols-1 sm:grid-cols-2 gap-5">
                        <div>
                            <label for="type" class="block text-sm font-medium text-gray-700 mb-1">Transaction Type</label>
                            <select id="type" name="type" required
                                class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus-ring-blue-500 sm:text-sm rounded-lg shadow-sm transition duration-150 ease-in-out bg-gray-50 hover:bg-white">
                                <option value="Sale">Sale (Revenue, +)</option>
                                <option value="Expense">Expense (Cost, -)</option>
                            </select>
                        </div>
                        <div>
                            <label for="brickType" class="block text-sm font-medium text-gray-700 mb-1">Brick Type (Optional)</label>
                            <select id="brickType" name="brickType"
                                class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus-ring-blue-500 sm:text-sm rounded-lg shadow-sm transition duration-150 ease-in-out bg-gray-50 hover:bg-white">
                                <option value="">Select a Brick Type</option>
                                <option value="Soil 8 inch bricks">Soil 8 inch bricks</option>
                                <option value="Soil 6 inch bricks">Soil 6 inch bricks</option>
                                <option value="Cement 8 inch bricks">Cement 8 inch bricks</option>
                                <option value="Cement 6 inch bricks">Cement 6 inch bricks</option>
                            </select>
                        </div>
                    </div>

                    <!-- Date & Amount --><div class="grid grid-cols-1 sm:grid-cols-2 gap-5">
                        <div>
                            <label for="date" class="block text-sm font-medium text-gray-700 mb-1">Date</label>
                            <input type="date" id="date" name="date" required
                                class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus-ring-blue-500 transition duration-150 ease-in-out bg-gray-50 hover:bg-white">
                        </div>
                        <div>
                            <label for="amount" class="block text-sm font-medium text-gray-700 mb-1">Amount (₹)</label>
                            <input type="number" id="amount" name="amount" required step="0.01" min="0.01"
                                class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus-ring-blue-500 transition duration-150 ease-in-out bg-gray-50 hover:bg-white">
                        </div>
                    </div>
                    
                    <!-- Customer Name & Number of Bricks --><div class="grid grid-cols-1 sm:grid-cols-2 gap-5">
                        <div>
                            <label for="customerName" class="block text-sm font-medium text-gray-700 mb-1">Customer Name/Supplier</label>
                            <input type="text" id="customerName" name="customerName" required
                                class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus-ring-blue-500 transition duration-150 ease-in-out bg-gray-50 hover:bg-white">
                        </div>
                        <div>
                            <label for="numberOfBricks" class="block text-sm font-medium text-gray-700 mb-1">Quantity (Bricks)</label>
                            <input type="number" id="numberOfBricks" name="numberOfBricks" required min="0" value="0"
                                class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus-ring-blue-500 transition duration-150 ease-in-out bg-gray-50 hover:bg-white">
                        </div>
                    </div>

                    <!-- Payment Status --><div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Payment Status</label>
                        <div class="mt-2 flex space-x-8">
                            <div class="flex items-center">
                                <input id="status-paid" name="paymentStatus" type="radio" value="Paid" checked
                                    class="focus:ring-blue-500 h-4 w-4 text-blue-600 border-gray-300">
                                <label for="status-paid" class="ml-2 block text-sm font-medium text-gray-700">Paid / Received</label>
                            </div>
                            <div class="flex items-center">
                                <input id="status-pending" name="paymentStatus" type="radio" value="Pending"
                                    class="focus:ring-yellow-500 h-4 w-4 text-yellow-600 border-gray-300">
                                <label for="status-pending" class="ml-2 block text-sm font-medium text-gray-700">Pending</label>
                            </div>
                        </div>
                    </div>

                    <!-- Description --><div>
                        <label for="description" class="block text-sm font-medium text-gray-700 mb-1">Item/Service Description (Optional notes)</label>
                        <textarea id="description" name="description" rows="2"
                            class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus-ring-blue-500 transition duration-150 ease-in-out bg-gray-50 hover:bg-white"></textarea>
                    </div>

                    <button type="submit"
                        class="w-full py-3 px-4 border border-transparent rounded-xl shadow-lg text-base font-semibold text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition duration-200 ease-in-out transform hover:scale-[1.005]">
                        Add Transaction
                    </button>
                    <p id="form-message" class="text-sm mt-3 text-center hidden font-medium"></p>
                </form>
            </section>
            
            <!-- Filter Bar: Premium Styling (Updated for equal size) -->
            <section class="bg-white p-4 rounded-xl shadow-lg border border-gray-100">
                <h3 class="text-sm font-bold text-gray-800 mb-3 border-b border-gray-100 pb-2">View Transaction Types:</h3>
                <!-- Use grid-cols-2 for mobile, grid-cols-4 for md+ for equal width -->
                <div class="grid grid-cols-2 md:grid-cols-4 gap-3"> 
                    <button onclick="setTransactionTypeFilter('All')" id="filter-all"
                        class="filter-btn w-full py-2 px-4 rounded-lg text-sm font-semibold bg-blue-700 text-white shadow-md hover:bg-blue-800 transition-all duration-200">
                        All Transactions
                    </button>
                    <button onclick="setTransactionTypeFilter('Sale')" id="filter-sale"
                        class="filter-btn w-full py-2 px-4 rounded-lg text-sm font-medium bg-white text-gray-700 border border-gray-200 shadow-sm hover:bg-gray-50 transition-all duration-200">
                        View Revenue
                    </button>
                    <button onclick="setTransactionTypeFilter('Expense')" id="filter-expense"
                        class="filter-btn w-full py-2 px-4 rounded-lg text-sm font-medium bg-white text-gray-700 border border-gray-200 shadow-sm hover:bg-gray-50 transition-all duration-200">
                        View Expenses
                    </button>
                    <button onclick="setTransactionTypeFilter('Pending')" id="filter-pending"
                        class="filter-btn w-full py-2 px-4 rounded-lg text-sm font-medium bg-white text-gray-700 border border-gray-200 shadow-sm hover:bg-gray-50 transition-all duration-200">
                        View Pending
                    </button>
                </div>
            </section>

            <!-- Ledger Table (Transactions) --><section class="bg-white p-6 md:p-8 rounded-xl shadow-2xl border border-gray-100 overflow-x-auto">
                <h2 id="ledger-history-title" class="text-2xl font-semibold mb-6 text-gray-800">Full Ledger History (Current Period)</h2>
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-100">
                        <tr>
                            <th class="px-4 py-3 text-left text-xs font-bold text-gray-700 uppercase tracking-wider">Date</th>
                            <th class="px-4 py-3 text-left text-xs font-bold text-gray-700 uppercase tracking-wider">Customer</th>
                            <th class="px-4 py-3 text-left text-xs font-bold text-gray-700 uppercase tracking-wider">Type</th>
                            <th class="px-4 py-3 text-right text-xs font-bold text-gray-700 uppercase tracking-wider">Bricks</th>
                            <th class="px-4 py-3 text-left text-xs font-bold text-gray-700 uppercase tracking-wider">Description</th>
                            <th class="px-4 py-3 text-center text-xs font-bold text-gray-700 uppercase tracking-wider">Status</th>
                            <th class="px-4 py-3 text-right text-xs font-bold text-gray-700 uppercase tracking-wider">Amount</th>
                            <th class="px-4 py-3 text-right text-xs font-bold text-gray-700 uppercase tracking-wider">R. Balance</th>
                            <th class="px-4 py-3 text-center text-xs font-bold text-gray-700 uppercase tracking-wider">Action</th>
                        </tr>
                    </thead>
                    <tbody id="ledger-body" class="bg-white divide-y divide-gray-100">
                        <!-- Transactions will be inserted here --><tr>
                            <td colspan="9" class="px-4 py-5 whitespace-nowrap text-sm text-gray-500 text-center">
                                No transactions recorded yet.
                            </td>
                        </tr>
                    </tbody>
                </table>
            </section>
        </main>
    </div>

    <!-- CLOSE PERIOD CONFIRMATION MODAL (PREMIUM STYLING) -->
    <div id="close-period-modal" class="modal-backdrop">
        <div class="modal-content w-11/12 max-w-lg p-8 rounded-xl shadow-2xl transition-all duration-300 border-t-8 border-red-600">
            
            <div class="flex items-start space-x-4">
                <!-- Warning Icon (using inline SVG for premium look) -->
                <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-red-600 mt-1 flex-shrink-0" viewBox="0 0 20 20" fill="currentColor">
                    <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.768 1.367-.202 3.08-1.742 3.08H4.419c-1.54 0-2.51-1.713-1.742-3.08l5.58-9.92zM10 13a1 1 0 100-2 1 1 0 000 2zm0-7a1 1 0 011 1v3a1 1 0 11-2 0V7a1 1 0 011-1z" clip-rule="evenodd" />
                </svg>

                <div>
                    <h3 class="text-2xl font-bold mb-1 text-gray-800">Final Ledger Closure Required</h3>
                    <p class="text-sm text-gray-600">This action cannot be undone for the current period's final balance.</p>
                </div>
            </div>

            <div class="mt-6 space-y-4 border-t border-b py-4 border-gray-100">
                <p class="text-gray-700 font-medium">
                    Closing Period ID: <span id="close-period-id" class="font-extrabold text-blue-700"></span>
                </p>
                <p class="text-gray-900 text-lg font-semibold">
                    Final Net Balance Recorded: <span id="close-final-balance" class="font-extrabold text-green-700"></span>
                </p>
                <p class="text-sm text-red-700 bg-red-50 p-3 rounded-lg font-medium">
                    The **NEW** ledger period will start with a **₹0.00** balance.
                </p>
            </div>

            <div class="flex justify-end space-x-3 pt-6">
                <button type="button" onclick="closeClosePeriodModal()"
                    class="py-2.5 px-4 border border-gray-300 rounded-lg shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-100 transition duration-150 ease-in-out">
                    Cancel
                </button>
                <button type="button" onclick="closeAndStartNewPeriod()" id="confirm-close-btn"
                    class="py-2.5 px-4 border border-transparent rounded-lg shadow-md text-base font-semibold text-white bg-red-600 hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500 transition duration-150 ease-in-out transform hover:scale-[1.02]">
                    Confirm & Close Ledger
                </button>
            </div>
        </div>
    </div>


    <!-- EDIT TRANSACTION MODAL (PREMIUM STYLING) -->
    <div id="edit-modal" class="modal-backdrop">
        <div class="modal-content w-11/12 max-w-lg p-8 rounded-xl shadow-2xl transition-all duration-300 border-t-8 border-blue-600">
            <h3 class="text-2xl font-bold mb-6 text-gray-800">Edit Transaction Details</h3>
            <form id="edit-transaction-form" class="space-y-4">
                <input type="hidden" id="edit-transaction-id" name="id">

                <!-- Type Selector & Brick Type -->
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label for="edit-type" class="block text-sm font-medium text-gray-700">Type</label>
                        <select id="edit-type" name="type" required disabled
                            class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 rounded-lg shadow-sm bg-gray-200">
                            <option value="Sale">Sale (Revenue, +)</option>
                            <option value="Expense">Expense (Cost, -)</option>
                        </select>
                        <p class="text-xs text-gray-500 mt-1">Type cannot be changed.</p>
                    </div>
                    <div>
                        <label for="edit-brickType" class="block text-sm font-medium text-gray-700">Brick Type (Optional)</label>
                        <select id="edit-brickType" name="brickType"
                            class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus-ring-blue-500 rounded-lg shadow-sm bg-gray-50 hover:bg-white">
                            <option value="">Select a Brick Type</option>
                            <option value="Soil 8 inch bricks">Soil 8 inch bricks</option>
                            <option value="Soil 6 inch bricks">Soil 6 inch bricks</option>
                            <option value="Cement 8 inch bricks">Cement 8 inch bricks</option>
                            <option value="Cement 6 inch bricks">Cement 6 inch bricks</option>
                        </select>
                    </div>
                </div>

                <!-- Date & Amount -->
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label for="edit-date" class="block text-sm font-medium text-gray-700">Date</label>
                        <input type="date" id="edit-date" name="date" required
                            class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus-ring-blue-500 bg-gray-50 hover:bg-white">
                    </div>
                    <div>
                        <label for="edit-amount" class="block text-sm font-medium text-gray-700">Amount (₹)</label>
                        <input type="number" id="edit-amount" name="amount" required step="0.01" min="0.01"
                            class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus-ring-blue-500 bg-gray-50 hover:bg-white">
                    </div>
                </div>
                
                <!-- Customer Name & Number of Bricks -->
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label for="edit-customerName" class="block text-sm font-medium text-gray-700">Customer Name/Supplier</label>
                        <input type="text" id="edit-customerName" name="customerName" required
                            class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus-ring-blue-500 bg-gray-50 hover:bg-white">
                    </div>
                    <div>
                        <label for="edit-numberOfBricks" class="block text-sm font-medium text-gray-700">Quantity (Bricks)</label>
                        <input type="number" id="edit-numberOfBricks" name="numberOfBricks" required min="0"
                            class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus-ring-blue-500 bg-gray-50 hover:bg-white">
                    </div>
                </div>

                <!-- Payment Status -->
                <div id="edit-status-container">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Payment Status</label>
                    <div class="mt-2 flex space-x-8">
                        <div class="flex items-center">
                            <input id="edit-status-paid" name="paymentStatus" type="radio" value="Paid"
                                class="focus:ring-blue-500 h-4 w-4 text-blue-600 border-gray-300">
                            <label for="edit-status-paid" class="ml-2 block text-sm font-medium text-gray-700">Paid / Received</label>
                        </div>
                        <div class="flex items-center">
                            <input id="edit-status-pending" name="paymentStatus" type="radio" value="Pending"
                                class="focus:ring-yellow-500 h-4 w-4 text-yellow-600 border-gray-300">
                            <label for="edit-status-pending" class="ml-2 block text-sm font-medium text-gray-700">Pending</label>
                        </div>
                    </div>
                </div>

                <!-- Description -->
                <div>
                    <label for="edit-description" class="block text-sm font-medium text-gray-700 mb-1">Item/Service Description (Optional notes)</label>
                    <textarea id="edit-description" name="description" rows="2"
                        class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus-ring-blue-500 bg-gray-50 hover:bg-white"></textarea>
                </div>

                <div class="flex justify-end space-x-3 pt-4">
                    <button type="button" onclick="closeEditModal()"
                        class="py-2.5 px-4 border border-gray-300 rounded-lg shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-100 transition duration-150 ease-in-out">
                        Cancel
                    </button>
                    <button type="submit"
                        class="py-2.5 px-4 border border-transparent rounded-lg shadow-md text-sm font-semibold text-white bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 transition duration-150 ease-in-out transform hover:scale-[1.02]">
                        Save Changes
                    </button>
                </div>
                <p id="edit-form-message" class="text-sm mt-3 text-center hidden font-medium"></p>
            </form>
        </div>
    </div>
    
    <!-- DELETE CONFIRMATION MODAL (NEW) -->
    <div id="delete-modal" class="modal-backdrop">
        <div class="modal-content w-11/12 max-w-sm p-6 rounded-xl shadow-2xl transition-all duration-300 border-t-8 border-red-600">
            <input type="hidden" id="delete-transaction-id-confirm">
            <div class="flex items-center space-x-4">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-red-600 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                </svg>
                <h3 class="text-lg font-bold text-gray-800">Confirm Deletion</h3>
            </div>
            <p class="text-sm text-gray-600 mt-4">Are you sure you want to permanently delete this transaction? This action cannot be undone.</p>
            
            <div class="flex justify-end space-x-3 pt-6">
                <button type="button" onclick="closeDeleteModal()"
                    class="py-2 px-4 border border-gray-300 rounded-lg shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-100 transition duration-150 ease-in-out">
                    Cancel
                </button>
                <button type="button" onclick="confirmDelete()"
                    class="py-2 px-4 border border-transparent rounded-lg shadow-md text-sm font-semibold text-white bg-red-600 hover:bg-red-700 transition duration-150 ease-in-out">
                    Delete Permanently
                </button>
            </div>
        </div>
    </div>

    <!-- Firebase SDKs --><script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, setPersistence, browserSessionPersistence } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, onSnapshot, serverTimestamp, setLogLevel, doc, updateDoc, setDoc, where, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Set log level for debugging
        setLogLevel('debug');

        // Global variables provided by the environment
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let db, auth, userId = null;
        const form = document.getElementById('transaction-form');
        const formMessage = document.getElementById('form-message');
        const ledgerBody = document.getElementById('ledger-body');
        const loadingSpinner = document.getElementById('loading-spinner');
        const mainContent = document.getElementById('main-content');
        const userIdDisplay = document.getElementById('user-id-display');
        const ledgerHistoryTitle = document.getElementById('ledger-history-title');
        const ledgerViewSelector = document.getElementById('ledger-view-selector');

        // Period Management State
        let currentPeriodId = null;
        let startingBalance = 0;
        let ledgerView = 'Current Period'; // 'Current Period' or 'All History'
        let currentRealizedNetBalance = 0; // Final realized balance for the current period
        
        // NEW State for Type Filtering
        let transactionTypeFilter = 'All'; // 'All', 'Sale', 'Expense', or 'Pending'


        // Period UI elements
        const currentPeriodDisplay = document.getElementById('current-period-display');
        const startingBalanceDisplay = document.getElementById('starting-balance-display');
        const closePeriodModal = document.getElementById('close-period-modal');
        const closePeriodIdDisplay = document.getElementById('close-period-id');
        const closeFinalBalanceDisplay = document.getElementById('close-final-balance');

        // Modal and Edit Form Elements
        const editModal = document.getElementById('edit-modal');
        const editForm = document.getElementById('edit-transaction-form');
        const editMessage = document.getElementById('edit-form-message');
        const editTransactionId = document.getElementById('edit-transaction-id');
        const editType = document.getElementById('edit-type');
        const editBrickType = document.getElementById('edit-brickType');
        const editDate = document.getElementById('edit-date');
        const editAmount = document.getElementById('edit-amount');
        const editCustomerName = document.getElementById('edit-customerName');
        const editNumberOfBricks = document.getElementById('edit-numberOfBricks');
        const editDescription = document.getElementById('edit-description');
        const editStatusContainer = document.getElementById('edit-status-container');
        const editStatusPaid = document.getElementById('edit-status-paid');
        const editStatusPending = document.getElementById('edit-status-pending');
        
        // Delete Modal Elements
        const deleteModal = document.getElementById('delete-modal');
        const deleteTransactionIdConfirm = document.getElementById('delete-transaction-id-confirm');


        // Helper function to format currency, now using INR (Indian Rupee)
        const formatCurrency = (amount) => {
            return new Intl.NumberFormat('en-IN', {
                style: 'currency',
                currency: 'INR'
            }).format(amount);
        };

        // Helper function to get today's date in YYYY-MM-DD format
        const getTodayDate = () => {
            return new Date().toISOString().split('T')[0];
        };
        
        // Helper function to get a unique Period ID (Date + milliseconds for uniqueness)
        const getUniquePeriodId = () => {
            const datePart = new Date().toISOString().split('T')[0]; // YYYY-MM-DD
            const timePart = new Date().getTime(); // Milliseconds since epoch
            return `${datePart}-${timePart}`;
        };
        
        // --- NEW FILTER LOGIC ---
        window.setTransactionTypeFilter = (type) => {
            if (transactionTypeFilter !== type) {
                transactionTypeFilter = type;
                renderLedger();
                updateFilterButtons(type);
            }
        }
        
        function updateFilterButtons(activeType) {
            const buttons = document.querySelectorAll('.filter-btn');
            buttons.forEach(btn => {
                // Check if the button ID includes the active type (e.g., 'filter-all', 'filter-sale', 'filter-pending')
                const isActive = btn.id.includes(activeType.toLowerCase());
                
                if (isActive) {
                    // Active style: Primary blue with stronger shadow and no border
                    btn.classList.remove('bg-white', 'text-gray-700', 'border', 'border-gray-200', 'shadow-sm', 'hover:bg-gray-50', 'font-medium');
                    btn.classList.add('bg-blue-700', 'text-white', 'hover:bg-blue-800', 'shadow-md', 'font-semibold');
                } else {
                    // Inactive style: Subtle light gray with shadow
                    btn.classList.remove('bg-blue-700', 'text-white', 'hover:bg-blue-800', 'shadow-md', 'font-semibold');
                    btn.classList.add('bg-white', 'text-gray-700', 'border', 'border-gray-200', 'shadow-sm', 'hover:bg-gray-50', 'font-medium');
                }
            });
        }


        // --- PERIOD MANAGEMENT MODAL CONTROLS ---

        window.openClosePeriodModal = () => {
            closePeriodIdDisplay.textContent = currentPeriodId;
            closeFinalBalanceDisplay.textContent = formatCurrency(currentRealizedNetBalance);
            closePeriodModal.style.display = 'block';
        };

        window.closeClosePeriodModal = () => {
            closePeriodModal.style.display = 'none';
        };
        
        // --- LEDGER VIEW SWITCHING ---
        window.switchLedgerView = (view) => {
            if (ledgerView !== view) {
                ledgerView = view;
                renderLedger(); // Re-render the ledger with the new filter
                
                // Update header text
                ledgerHistoryTitle.textContent = view === 'Current Period' 
                    ? `Full Ledger History (Active Period: ${currentPeriodId})`
                    : 'Full Ledger History (All Time)';
            }
        };


        // --- FIREBASE INITIALIZATION AND AUTHENTICATION ---
        async function initFirebase() {
            if (!firebaseConfig) {
                console.error("Firebase configuration not found. Cannot initialize Firestore.");
                loadingSpinner.innerHTML = '<p class="text-red-500">Error: Firebase configuration missing.</p>';
                return;
            }

            const app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);

            try {
                await setPersistence(auth, browserSessionPersistence);

                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }

                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                        userIdDisplay.textContent = `User ID (Share this for collaboration): ${userId}`;
                        userIdDisplay.classList.remove('hidden');
                        
                        await initializeLedgerStatus(); // Initialize Period Status
                        
                        loadingSpinner.classList.add('hidden');
                        mainContent.classList.remove('hidden');
                        loadTransactions(); 
                    } else {
                        console.log("No user signed in.");
                        loadingSpinner.innerHTML = '<p class="text-red-500">Authentication failed.</p>';
                    }
                });
            } catch (error) {
                console.error("Firebase initialization or authentication failed:", error);
                loadingSpinner.innerHTML = `<p class="text-red-500">Error during authentication: ${error.message}</p>`;
            }
        }

        // --- PERIOD STATUS INITIALIZATION ---
        async function initializeLedgerStatus() {
            const statusDocRef = doc(db, 'artifacts', appId, 'users', userId, 'metadata', 'ledger_status');

            onSnapshot(statusDocRef, (docSnap) => {
                if (docSnap.exists()) {
                    const status = docSnap.data();
                    currentPeriodId = status.currentPeriodId;
                    startingBalance = status.startingBalance || 0;
                } else {
                    // Initialize ledger status for a new user
                    currentPeriodId = getUniquePeriodId(); // Use unique ID
                    startingBalance = 0;
                    
                    setDoc(statusDocRef, {
                        currentPeriodId: currentPeriodId,
                        startingBalance: startingBalance,
                        initializedDate: serverTimestamp()
                    });
                }
                
                // Update UI displays
                currentPeriodDisplay.textContent = currentPeriodId;
                startingBalanceDisplay.textContent = formatCurrency(startingBalance);
                
                // Update net balance card label when view is 'All History'
                const netBalanceLabel = document.getElementById('net-balance-label');
                if (netBalanceLabel) {
                    netBalanceLabel.textContent = ledgerView === 'Current Period' ? 'Realized Net Balance (Period)' : 'Realized Net Balance (All Time)';
                }
                
                ledgerHistoryTitle.textContent = ledgerView === 'Current Period' 
                    ? `Full Ledger History (Active Period: ${currentPeriodId})`
                    : 'Full Ledger History (All Time)';
            }, (error) => {
                console.error("Error fetching ledger status:", error);
            });
        }

        // --- REAL-TIME DATA LISTENER AND RENDERING ---

        // Stores all transaction objects for sorting/calculations
        let allTransactions = [];

        function loadTransactions() {
            if (!db || !userId) return;

            const transactionsRef = collection(db, 'artifacts', appId, 'users', userId, 'transactions');
            
            // Set up real-time listener on ALL transactions (we filter in JS to avoid index issues)
            onSnapshot(transactionsRef, (snapshot) => {
                allTransactions = [];
                snapshot.forEach((doc) => {
                    allTransactions.push({ id: doc.id, ...doc.data() });
                });
                // Rerender every time data changes
                renderLedger(); 
            }, (error) => {
                console.error("Error listening to transactions:", error);
                formMessage.textContent = "Error loading ledger. See console for details.";
                formMessage.classList.remove('hidden', 'text-green-500');
                formMessage.classList.add('text-red-500');
            });
        }

        function renderLedger() {
            // --- 1. Filter Data by PERIOD for Summary and Display ---
            const transactionsForSummaryAndCalculation = ledgerView === 'Current Period' && currentPeriodId
                ? allTransactions.filter(t => t.periodId === currentPeriodId)
                : allTransactions;
            
            // Apply TYPE filter ONLY to the display set
            let transactionsToDisplay = transactionsForSummaryAndCalculation;
            
            if (transactionTypeFilter === 'Sale' || transactionTypeFilter === 'Expense') {
                transactionsToDisplay = transactionsToDisplay.filter(t => t.type === transactionTypeFilter);
            } else if (transactionTypeFilter === 'Pending') {
                // Filter for Sales that are specifically marked as Pending
                transactionsToDisplay = transactionsToDisplay.filter(t => t.paymentStatus === 'Pending' && t.type === 'Sale');
            }
            
            // --- 2. Calculate Summary Metrics (Based on PERIOD Filter Only) ---
            let realizedRunningBalanceSummary = ledgerView === 'Current Period' ? startingBalance : 0;
            let grossRevenue = 0;
            let totalExpenses = 0;
            let totalPendingRevenue = 0;

            transactionsForSummaryAndCalculation.forEach(t => {
                const amountValue = parseFloat(t.amount);
                const isSale = t.type === 'Sale';
                const isPendingSale = isSale && t.paymentStatus === 'Pending';
                const isExpense = t.type === 'Expense';

                if (isSale) {
                    grossRevenue += amountValue;
                    if (isPendingSale) {
                        totalPendingRevenue += amountValue;
                    }
                } else if (isExpense) {
                    totalExpenses += amountValue;
                }
                
                let signedRealizedAmount = 0;
                if (isSale && !isPendingSale) {
                    signedRealizedAmount = amountValue;
                } else if (isExpense) {
                    signedRealizedAmount = -amountValue;
                }
                realizedRunningBalanceSummary += signedRealizedAmount;
            });

            // Store final balance for closing procedure
            currentRealizedNetBalance = realizedRunningBalanceSummary; 

            // 3. Update Summary Cards (Using PERIOD Totals)
            const netBalanceLabel = document.getElementById('net-balance-label');
            netBalanceLabel.textContent = ledgerView === 'Current Period' ? 'Realized Net Balance (Period)' : 'Realized Net Balance (All Time)';
            document.getElementById('total-revenue').textContent = formatCurrency(grossRevenue);
            document.getElementById('total-expenses').textContent = formatCurrency(totalExpenses);
            document.getElementById('pending-revenue').textContent = formatCurrency(totalPendingRevenue);
            document.getElementById('net-balance').textContent = formatCurrency(realizedRunningBalanceSummary);
            
            const netBalanceCard = document.getElementById('net-balance').parentElement;
            const cardBorderDiv = netBalanceCard.querySelector('div');
            cardBorderDiv.classList.remove('bg-green-600', 'bg-red-600');
            if (realizedRunningBalanceSummary >= 0) {
                cardBorderDiv.classList.add('bg-green-600');
                document.getElementById('net-balance').classList.remove('text-red-800');
                document.getElementById('net-balance').classList.add('text-green-800');
            } else {
                cardBorderDiv.classList.add('bg-red-600');
                document.getElementById('net-balance').classList.remove('text-green-800');
                document.getElementById('net-balance').classList.add('text-red-800');
            }

            // --- 4. Render Table Rows ---
            
            // The running balance for the table must be calculated based on the filtered list, 
            // but the running total must start from the appropriate point (startingBalance for current period).
            let realizedRunningBalanceTable = ledgerView === 'Current Period' ? startingBalance : 0;
            
            // Sort transactions by date and timestamp
            const sortedTransactions = transactionsToDisplay.sort((a, b) => {
                const dateA = a.date + (a.timestamp ? a.timestamp.toMillis() : 0);
                const dateB = b.date + (b.timestamp ? b.timestamp.toMillis() : 0);
                if (dateA < dateB) return -1;
                if (dateA > dateB) return 1;
                return 0;
            });
            
            ledgerBody.innerHTML = '';
            
            if (sortedTransactions.length === 0 && (ledgerView !== 'Current Period' || startingBalance === 0)) {
                 ledgerBody.innerHTML = `
                    <tr>
                        <td colspan="9" class="px-4 py-5 whitespace-nowrap text-sm text-gray-500 text-center">
                            No transactions recorded matching the selected filters.
                        </td>
                    </tr>
                `;
            }

            // If viewing current period, add a starting balance row
            if (ledgerView === 'Current Period' && startingBalance !== 0) {
                 const balanceClass = realizedRunningBalanceTable >= 0 ? 'text-green-700 font-semibold' : 'text-red-700 font-semibold';
                 const startingRow = `
                    <tr class="bg-blue-50">
                        <td class="px-4 py-2 whitespace-nowrap text-sm text-blue-800 font-bold">START</td>
                        <td class="px-4 py-2 text-sm text-gray-500" colspan="5">Balance Carried Forward from ${currentPeriodId}</td>
                        <td class="px-4 py-2 whitespace-nowrap text-right text-sm font-medium">—</td>
                        <td class="px-4 py-2 whitespace-nowrap text-right text-sm ${balanceClass} font-bold">
                            ${formatCurrency(startingBalance)}
                        </td>
                        <td class="px-4 py-2 whitespace-nowrap text-center text-sm">—</td>
                    </tr>
                 `;
                 ledgerBody.insertAdjacentHTML('beforeend', startingRow);
            }


            sortedTransactions.forEach(t => {
                const amountValue = parseFloat(t.amount);
                const paymentStatus = t.paymentStatus || 'Paid';
                const numberOfBricks = t.numberOfBricks !== undefined ? t.numberOfBricks : 0;
                const brickType = t.brickType || 'N/A';
                const description = t.description || '—';

                const isSale = t.type === 'Sale';
                const isPendingSale = isSale && paymentStatus === 'Pending';
                const isExpense = t.type === 'Expense';

                // Recalculate running balance based only on the items currently DISPLAYED
                // This is only visually for the table; the true ledger balance is the summary one.
                let signedRealizedAmount = 0;
                if (isSale && !isPendingSale) {
                    signedRealizedAmount = amountValue;
                } else if (isExpense) {
                    signedRealizedAmount = -amountValue;
                }
                
                // Only update the running balance if we are not specifically filtering for pending (which doesn't affect the balance)
                if (transactionTypeFilter !== 'Pending') {
                    realizedRunningBalanceTable += signedRealizedAmount;
                }

                // --- ROW RENDERING ---
                const amountClass = isSale ? 'text-blue-700 font-medium' : 'text-red-700 font-medium';
                // Note: Running balance column is hidden if filtering by a single type, but we keep the logic here
                const balanceClass = realizedRunningBalanceTable >= 0 ? 'text-green-700 font-semibold' : 'text-red-700 font-semibold';
                const rowBgClass = isPendingSale ? 'bg-yellow-50 hover:bg-yellow-100' : 'hover:bg-gray-50';
                const statusClass = isPendingSale ? 'text-yellow-700 font-semibold' : 'text-green-700';

                // Format number of bricks with commas
                const formattedBricks = new Intl.NumberFormat('en-IN').format(numberOfBricks);

                const row = `
                    <tr class="${rowBgClass} transition-colors duration-150">
                        <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-800">${t.date}</td>
                        <td class="px-4 py-2 text-sm text-gray-800">${t.customerName || 'N/A'}</td>
                        <td class="px-4 py-2 text-sm text-gray-600 max-w-[120px] truncate">${brickType}</td>
                        <td class="px-4 py-2 whitespace-nowrap text-right text-sm text-gray-700">${formattedBricks}</td>
                        <td class="px-4 py-2 text-sm text-gray-600 max-w-xs truncate">${description}</td>
                        <td class="px-4 py-2 whitespace-nowrap text-center text-xs ${statusClass}">
                            ${paymentStatus}
                        </td>
                        <td class="px-4 py-2 whitespace-nowrap text-right text-sm ${amountClass}">
                            ${isExpense ? '-' : ''}${formatCurrency(amountValue)}
                        </td>
                        <td class="px-4 py-2 whitespace-nowrap text-right text-sm ${balanceClass}">
                            ${transactionTypeFilter === 'Pending' ? '—' : formatCurrency(realizedRunningBalanceTable)}
                        </td>
                        <td class="px-4 py-2 whitespace-nowrap text-center text-sm space-x-2">
                            <button onclick="openEditModal('${t.id}')" title="Edit Transaction"
                                class="text-blue-600 hover:text-blue-800 font-medium p-1 rounded-md hover:bg-blue-100 transition-colors">
                                Edit
                            </button>
                            <button onclick="openDeleteModal('${t.id}')" title="Delete Transaction"
                                class="text-red-600 hover:text-red-800 font-medium p-1 rounded-md hover:bg-red-100 transition-colors">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 inline-block" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                                </svg>
                            </button>
                        </td>
                    </tr>
                `;
                ledgerBody.insertAdjacentHTML('beforeend', row);
            });
            
            // Ensure the correct filter button is highlighted on load/re-render
            updateFilterButtons(transactionTypeFilter);
        }
        
        // --- CLOSE PERIOD LOGIC ---
        window.closeAndStartNewPeriod = async () => {
            const statusDocRef = doc(db, 'artifacts', appId, 'users', userId, 'metadata', 'ledger_status');
            const newPeriodId = getUniquePeriodId(); // Use unique ID to allow immediate re-closing
            
            // NOTE: The daily restriction check has been removed.

            try {
                document.getElementById('confirm-close-btn').disabled = true;

                await updateDoc(statusDocRef, {
                    currentPeriodId: newPeriodId,
                    startingBalance: 0, // <-- Balance reset to ZERO
                    lastClosedDate: serverTimestamp(),
                    previousPeriodId: currentPeriodId,
                    previousClosingBalance: currentRealizedNetBalance // Retain closing balance for history
                });

                // Update current period state immediately (onSnapshot will handle final rendering)
                currentPeriodId = newPeriodId;
                startingBalance = 0; // <-- Local state reset to ZERO
                
                closeClosePeriodModal();
                // Switch back to the new current period view
                ledgerView = 'Current Period';
                ledgerViewSelector.value = 'Current Period';
                
                formMessage.textContent = `Ledger Closed! New period (${currentPeriodId}) started with a fresh ₹0.00 balance.`;
                formMessage.classList.remove('hidden', 'text-red-600');
                formMessage.classList.add('text-green-600'); 

                setTimeout(() => { formMessage.classList.add('hidden'); }, 5000);

            } catch (error) {
                console.error("Error closing period:", error);
                // Check 2: Replace alert() with message display for general errors
                formMessage.textContent = "Error: Failed to close ledger period. Check console for details.";
                formMessage.classList.remove('hidden', 'text-green-600');
                formMessage.classList.add('text-red-600');
                setTimeout(() => { formMessage.classList.add('hidden'); }, 5000);
            } finally {
                document.getElementById('confirm-close-btn').disabled = false;
            }
        }


        // --- NEW TRANSACTION FORM SUBMISSION ---
        form.addEventListener('submit', async (e) => {
            e.preventDefault();

            const formData = new FormData(form);
            const type = formData.get('type');
            
            const brickTypeRaw = formData.get('brickType');
            const brickType = brickTypeRaw || 'N/A'; 

            const date = formData.get('date');
            const customerName = formData.get('customerName').trim();
            
            const description = formData.get('description').trim();

            const amount = parseFloat(formData.get('amount'));
            const numberOfBricks = parseInt(formData.get('numberOfBricks')); 
            const paymentStatus = formData.get('paymentStatus');

            if (!db || !userId || isNaN(amount) || amount <= 0 || !date || !customerName || !paymentStatus || isNaN(numberOfBricks) || numberOfBricks < 0) {
                formMessage.textContent = "Please fill out all required fields (Type, Date, Amount > 0, Customer/Supplier, Bricks >= 0, and Payment Status).";
                formMessage.classList.remove('hidden', 'text-green-500');
                formMessage.classList.add('text-red-600'); 
                return;
            }

            try {
                const transactionsRef = collection(db, 'artifacts', appId, 'users', userId, 'transactions');
                
                await addDoc(transactionsRef, {
                    type: type, 
                    brickType: brickType, 
                    date: date, 
                    customerName: customerName,
                    numberOfBricks: numberOfBricks, 
                    description: description, 
                    amount: amount, 
                    paymentStatus: type === 'Expense' ? 'Paid' : paymentStatus, 
                    timestamp: serverTimestamp(),
                    periodId: currentPeriodId, 
                });

                form.reset();
                document.getElementById('brickType').value = ""; 
                document.getElementById('numberOfBricks').value = 0; 
                document.getElementById('status-paid').checked = true; 
                
                formMessage.textContent = `New ${type} transaction recorded successfully!`;
                formMessage.classList.remove('hidden', 'text-red-600');
                formMessage.classList.add('text-green-600'); 
            } catch (error) {
                console.error("Error adding document: ", error);
                formMessage.textContent = "Failed to record transaction. See console for details.";
                formMessage.classList.remove('hidden', 'text-green-600');
                formMessage.classList.add('text-red-600');
            }

            setTimeout(() => {
                formMessage.classList.add('hidden');
            }, 3000);
        });
        
        // --- EDIT TRANSACTION MODAL & LOGIC ---

        window.openEditModal = (transactionId) => {
            const transaction = allTransactions.find(t => t.id === transactionId);
            if (!transaction) {
                console.error("Transaction not found:", transactionId);
                return;
            }

            // Populate form fields
            editTransactionId.value = transaction.id;
            editType.value = transaction.type;
            editBrickType.value = transaction.brickType === 'N/A' ? '' : transaction.brickType;
            editDate.value = transaction.date;
            editAmount.value = transaction.amount;
            editCustomerName.value = transaction.customerName;
            editNumberOfBricks.value = transaction.numberOfBricks;
            editDescription.value = transaction.description;

            // Handle Payment Status Visibility and Selection
            if (transaction.type === 'Expense') {
                editStatusContainer.classList.add('hidden');
            } else {
                editStatusContainer.classList.remove('hidden');
                if (transaction.paymentStatus === 'Paid') {
                    editStatusPaid.checked = true;
                } else {
                    editStatusPending.checked = true;
                }
            }

            editModal.style.display = 'block';
            editMessage.classList.add('hidden');
        };

        window.closeEditModal = () => {
            editModal.style.display = 'none';
            editForm.reset();
        };

        // Close modal when clicking outside
        editModal.addEventListener('click', (e) => {
            if (e.target === editModal) {
                closeEditModal();
            }
        });

        editForm.addEventListener('submit', async (e) => {
            e.preventDefault();

            const transactionId = editTransactionId.value;
            if (!transactionId) {
                editMessage.textContent = "Error: Transaction ID missing.";
                editMessage.classList.remove('hidden', 'text-green-600');
                editMessage.classList.add('text-red-600'); 
                return;
            }
            
            const formData = new FormData(editForm);
            const type = formData.get('type');
            
            const brickTypeRaw = formData.get('edit-brickType'); 
            const brickType = brickTypeRaw || 'N/A'; 

            const date = formData.get('date');
            const customerName = formData.get('customerName').trim();
            
            const description = formData.get('description').trim();

            const amount = parseFloat(formData.get('amount'));
            const numberOfBricks = parseInt(formData.get('numberOfBricks')); 
            const paymentStatus = type === 'Expense' ? 'Paid' : formData.get('paymentStatus'); 

            // Validation
            if (isNaN(amount) || amount <= 0 || !date || !customerName || isNaN(numberOfBricks) || numberOfBricks < 0) {
                editMessage.textContent = "Please fill out all required fields with valid data.";
                editMessage.classList.remove('hidden', 'text-green-600');
                editMessage.classList.add('text-red-600'); 
                return;
            }
            
            try {
                const transactionDocRef = doc(db, 'artifacts', appId, 'users', userId, 'transactions', transactionId);
                
                await updateDoc(transactionDocRef, {
                    brickType: brickType, 
                    date: date, 
                    customerName: customerName,
                    numberOfBricks: numberOfBricks, 
                    description: description, 
                    amount: amount, 
                    paymentStatus: paymentStatus, 
                    // periodId is retained from creation
                });

                editMessage.textContent = `Transaction updated successfully!`;
                editMessage.classList.remove('hidden', 'text-red-600');
                editMessage.classList.add('text-green-600'); 
                
                // Close modal after a short delay
                setTimeout(() => {
                    closeEditModal();
                }, 1000);

            } catch (error) {
                console.error("Error updating document: ", error);
                editMessage.textContent = "Failed to update transaction. See console for details.";
                editMessage.classList.remove('hidden', 'text-green-600');
                editMessage.classList.add('text-red-600');
            }
        });
        
        // --- DELETE TRANSACTION LOGIC ---
        
        window.openDeleteModal = (transactionId) => {
            deleteTransactionIdConfirm.value = transactionId;
            deleteModal.style.display = 'block';
        };

        window.closeDeleteModal = () => {
            deleteTransactionIdConfirm.value = '';
            deleteModal.style.display = 'none';
        };

        window.confirmDelete = async () => {
            const transactionId = deleteTransactionIdConfirm.value;
            if (!transactionId) {
                console.error("No transaction ID available for deletion.");
                closeDeleteModal();
                return;
            }
            
            try {
                const transactionDocRef = doc(db, 'artifacts', appId, 'users', userId, 'transactions', transactionId);
                await deleteDoc(transactionDocRef);
                
                formMessage.textContent = `Transaction deleted successfully!`;
                formMessage.classList.remove('hidden', 'text-red-600');
                formMessage.classList.add('text-green-600'); 
                
                // Clear message after 3 seconds
                setTimeout(() => {
                    formMessage.classList.add('hidden');
                }, 3000);

            } catch (error) {
                console.error("Error deleting document:", error);
                formMessage.textContent = "Failed to delete transaction. See console for details.";
                formMessage.classList.remove('hidden', 'text-green-600');
                formMessage.classList.add('text-red-600');
            } finally {
                closeDeleteModal();
            }
        };

        // Close delete modal when clicking outside
        deleteModal.addEventListener('click', (e) => {
            if (e.target === deleteModal) {
                closeDeleteModal();
            }
        });

        // Initialize the application
        initFirebase();
    </script>
</body>
</html>

